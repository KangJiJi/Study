# CHAPTER 2 렉시컬 스코프

&nbsp;스코프는 두가지 방식으로 작동한다. 일반적으로 사용하는 '렉시컬 스코프(Lexical Scope)'와 몇몇 언어에서 사용하는 '동적 스코프(Dynamic Scope)'가 있다. 자바스크립트에서는 렉시컬 스코프를 채용했다.

## 1. 렉스 타임

&nbsp;렉시컬 스코프는 렉싱 타임(Lexing Time)에 정의되는 스코프이며, 렉서(lexer)가 코드를 처리할 때 확정된다.

```javascript
// Bubble 1
function foo(a) {
  // Bubble 2
  var b = a * 2;
  function bar(c) {
    // Bubble 3
    console.log(a, b, c);
  }
  bar(b * 3);
}

foo(2); // 2, 4, 12
```

위 코드에는 3개의 중첩 스코프가 있고 각각의 스코프를 버블이라고 생각할 수 있다.

- Bubble1 은 글로벌 스코프를 감싸고 있고, 하나의 확인자(`foo`)를 포함한다.
- Bubble2 는 `foo`의 스코프를 감싸고 있고, 세개의 확인자(`a`, `bar`, `b`)를 포함한다.
- Bubble3 은 `bar`의 스코프를 감싸고 있고, 하나의 확인자(`c`)만을 포함한다.

또한 어떤 함수의 버블도 동시에 다른 두 스코프 안에 존재할 수 없다.

### 검색

&nbsp;현재 스코프에서 상위 스코프로 검색을 진행하는데, 중첩 스코프에서 같은 확인자 이름을 만들 수 있다. 이를 '섀도잉(Shadowing)'이라 한다. 글로벌 변수에는 `window.a`와 같이 접근이 가능하지만 다른 섀도 변수는 접근할 수 없다.

## 2. 렉시컬 속이기

&nbsp;렉시컬을 속일 수 있는 두가지 방법이 있다. 하지만 이러한 방법은 권장하지 않는 방법이며, 렉시컬 스코프를 속이면 성능까지 떨어지게 된다.

### eval

&nbsp;`eval()`함수는 문자열을 인자값으로 처음 부터 있었던 것처럼 실행한다.

```javascript
function foo(str, a) {
  eval(str); // cheating
  console.log(a, b);
}
var b = 2;
foo("var b = 3", 1); // 1, 3
```

이미 존재하는 `foo()`의 렉시컬 스코프를 런타임에 수정한다. 따라서 글로벌 스코프의 `b`가 아닌 3이 출력된다. 하지만 'Strict Mode'에서는 `eval()`은 자체적인 렉시컬 스코프를 이용하기 때문에 참조할 수 없다.

`setTimeout()`, `setInterval()`, `new Function()`도 동적으로 변경할 수 있지만 모두 사용을 권장하지 않는 방법이다.

### with

&nbsp;`with`는 렉시컬 스코프를 속일 수 있는 기능이지만 곧 없어질 예정이라 사용을 권장하지 않는다. `with`는 다음과 같이 사용할 수 있다.

```javascript
var obj = {
  a: 1,
  b: 2,
  c: 3,
};

// 참조를 매번 반복하지 않아도 된다(속기법).
with (obj) {
  a = 3;
  b = 4;
  c = 5;
}
```

`with`는 다음과 같은 특이한 Side effect가 있다.

```javascript
function foo(obj) {
  with (obj) {
    a = 2;
  }
}

var o2 = {
  b: 3,
};

foo(o2);
console.log(o2.a); // undefined
console.log(a); // 2
```

`with`문은 독립된 렉시컬 스코프처럼 취급된다. 따라서 `o2`안에 `a`가 존재하지 않기 때문에 글로벌 스코프에 변수를 만들고 대입을 한 것이다.

`eval()`은 인자로 받은 코드에 선언문이 있을 때 렉시컬 스코프를 수정할 수 있다. 하지만 `with`문은 새로운 하나의 렉시컬 스코프를 생성한다. 아무튼 둘다 사용하면 안된다.

### 성능

&nbsp;자바스크립트 엔진은 컴파일레이션 단계에서 최적화를 진행한다. 최적화 작업의 핵심은 확인자 검색을 더 빠르게 하는 것이다. 하지만 `eval()`이나 `with`가 존재하면 최적화 하지 않은 것과 마찬가지가 된다.

## 3. 정리하기

&nbsp;렉시컬 스코프란 함수를 어디에 선언하는지에 따라 정의되는 스코프다. 렉싱 단계에서 확인자를 파악해 실행 단계에서 확인자 검색을 도와준다. 또한 렉시컬 스코프를 속이는 `eval()`, `with` 두 가지 방법이 있으며, 둘다 사용을 권장하지 않는다. 최적화 작업을 무산시켜 성능에 영향을 미치기 때문이다.
